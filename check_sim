#! /bin/bash

# include some files
OSTMU_FOLDER="/opt/ostmu"
source "${OSTMU_FOLDER}/etc/config"

# define some vars
USER_NAME=$1
SIM_NAME=$2

show_help() {
  echo $"Usage : check_sim <user_name> <sim_name>"
  exit;
}

# begin of logic
if [ $# -lt 2 ];then
  show_help
  exit;
fi

# check if the user exists
if user_exists ${USER_NAME} > /dev/null; then
  echo -e ${SymbolOk} $"The user ${USER_NAME} exists."
else
  echo -e ${SymbolNotOk} $"The user ${USER_NAME} does not exist."
  exit 1;
fi

# check if the simulator folder exists
if simulator_folder_exists ${USER_NAME} ${SIM_NAME} > /dev/null;then
  echo -e ${SymbolOk} $"The folder ${SIM_FOLDER} exists."
else
  echo -e ${SymbolNotOk} $"The folder ${SIM_FOLDER} does not exist."
  exit 1;
fi

# check the simulator pid
PID=$(get_sim_pid ${USER_NAME} ${SIM_NAME})
if [ $? = 0 ]; then
  print_message "${_THE_PID_FILE} ${_EXISTS}."
  if check_pid ${PID} > /dev/null;then
    echo -e ${SymbolOk} $"PID is running."
  else
    echo -e ${SymbolNotOk} $"PID is not running."
  fi
else
  echo -e ${SymbolNotOk} $"The file PID does not exist."
  exit 1;
fi

# check if the tmux session is running
if tmux_session_exists "os-${USER_NAME}"; then
  echo -e ${SymbolOk} $"The tmux session is running."
else
  echo -e ${SymbolNotOk} $"The tmux session is not running."
fi

# check if the tmux window is running
if tmux_window_exists "os-${USER_NAME}" "${SIM_NAME}"; then
  echo -e ${SymbolOk} $"The tmux window is running."
else
  echo -e ${SymbolNotOk} $"The tmux window is not running."
  exit 1;
fi

# check if the console is answering
if simulator_console_is_answering "${USER_NAME}" "${SIM_NAME}"; then
  echo -e ${SymbolOk} $"The simulator console is answering."
else
  echo -e ${SymbolNotOk} $"The simulator console is not answering."
  exit 1;
fi
