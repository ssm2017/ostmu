#! /bin/bash

# check if root
if [[ $EUID -ne 0 ]]; then
   echo $"This script must be run as root." 1>&2
   exit 1
fi

# include the config
OSTMU_FOLDER="/opt/ostmu"
source "${OSTMU_FOLDER}/etc/config"

# check if the opensimulator bin files exist
if [ ! -d "${OPENSIMULATOR_FOLDER}" ];then
  echo -e ${SymbolNotOk} $"The opensimulator bin folder does not exist."
  exit 1;
fi
echo -e ${SymbolOk} $"The opensimulator bin folder exists."

# check if the socket folder exist
if [ ! -d "${TMUX_SOCKET_FOLDER}" ]; then
  mkdir -p "${TMUX_SOCKET_FOLDER}"
  if [ ! $? -eq 0 ]; then
    exit 1;
  else
    echo -e ${SymbolOk} $"The folder ${TMUX_SOCKET_FOLDER} was created."
  fi
else
  echo -e ${SymbolOk} $"The folder ${TMUX_SOCKET_FOLDER} exists."
fi

# check ig the socket folder has the good group ownership
if [ $(stat -c %G "${TMUX_SOCKET_FOLDER}") != "${TMUX_SOCKET_FOLDER_GROUP_NAME}" ]; then
  chown root:"${TMUX_SOCKET_FOLDER_GROUP_NAME}" "${TMUX_SOCKET_FOLDER}"
  if [ ! $? -eq 0 ]; then
    exit 1;
  else
    echo -e ${SymbolOk} $"Group ownership changed for folder ${TMUX_SOCKET_FOLDER}."
  fi
else
  echo -e ${SymbolOk} $"The folder ${TMUX_SOCKET_FOLDER} has good group ownership."
fi

# check if the socket folder is writable to everyone
if [ ! $(stat -c %a "${TMUX_SOCKET_FOLDER}") = "2770" ]; then
  chmod 2770 "${TMUX_SOCKET_FOLDER}"
  if [ ! $? -eq 0 ]; then
    exit 1;
  else
    echo -e ${SymbolOk} $"The permissions were set to 2770 for the folder ${TMUX_SOCKET_FOLDER}."
  fi
else
  echo -e ${SymbolOk} $"The permissions of the folder ${TMUX_SOCKET_FOLDER} are 2770."
fi
